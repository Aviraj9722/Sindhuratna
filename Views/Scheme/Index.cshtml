@inject Umbraco.Cms.Core.IPublishedContentQuery ContentQuery
@{
    var root = ContentQuery.ContentAtRoot().FirstOrDefault();
    // var homePage = root as Root;

    var Schemes = root?
         .DescendantsOfType("governmentScheme")
         .OfType<GovernmentScheme>()
         .ToList();
}
@{
    Layout = "~/Views/Shared/_SindhuratnLayout.cshtml";
}

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- DataTables -->
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">

<!-- Font Awesome Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<style>
    .place-thumb {
        /* width: 70px;
            height: 70px; */
        object-fit: cover;
    }

    @@media (max-width: 768px) {
        .place-thumb {
            width: 100%;
            height: 120px;
        }
    }
</style>
<div class="container mt-4">
    <h4 class="mb-3 fw-semibold">
        <i class="fa-solid fa-map-location-dot text-warning"></i> Government Schemes
    </h4>

    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <input type="text"
                   id="customSearch"
                   class="form-control"
                   placeholder="Search scheme, department, audience...">
        </div>

        <div class="col-md-6 text-end">
            <select id="sortBy" class="form-select w-auto d-inline">
                <option value="">Sort By</option>
                <option value="name-asc">Scheme Name A → Z</option>
                <option value="status-asc">Status</option>
                <option value="level-asc">Scheme Level</option>
            </select>
        </div>
    </div>

    <!-- Header -->
    <div class="row fw-bold border-bottom py-2 text-muted d-none d-sm-flex small">
        <div class="col-md-2">Scheme</div>
        <div class="col-md-3">Description</div>
        <div class="col-md-1">Type</div>
        <div class="col-md-1">Status</div>
        <div class="col-md-2">Department</div>
        <div class="col-md-2">Target Audience</div>
        <div class="col-md-1 text-end">Action</div>
    </div>


    <!-- DATA -->
    <div id="hotelWrapper">
        @foreach (var obj in Schemes)
        {
            var audiences = obj?.TargetAudience?.ToList() ?? new List<string>();

            <div class="row align-items-center border-bottom py-3 hotel-item"
                 data-name="@obj.SchemeName"
                 data-status="@obj.Status"
                 data-level="@obj.SchemeLevel">

                <!-- SCHEME NAME -->
                <div class="col-md-2 fw-semibold">
                    <i class="fa-solid fa-file-contract text-primary"></i>
                    @obj.SchemeName
                </div>

                <!-- DESCRIPTION -->
                <div class="col-md-3 small text-muted">
                    <div><i class="fa-solid fa-layer-group"></i> @obj.SchemeLevel</div>
                    <div>@obj.ShortDescription</div>
                    <div class="text-secondary">
                        <i class="fa-solid fa-laptop"></i> @obj.ApplicationMode
                    </div>
                </div>

                <!-- TYPE -->
                <div class="col-md-1">
                    <span class="badge bg-light text-dark">
                        <i class="fa-solid fa-tags"></i> @obj.SchemeType
                    </span>
                </div>

                <!-- STATUS -->
                <div class="col-md-1">
                    <span class="badge @(obj.Status == "Active" ? "bg-success" : "bg-secondary")">
                        @obj.Status
                    </span>
                </div>

                <!-- DEPARTMENT -->
                <div class="col-md-2">
                    <i class="fa-solid fa-building-columns text-muted"></i>
                    @obj.Department
                </div>

                <!-- TARGET AUDIENCE -->
                <div class="col-md-2 small">
                    @foreach (var a in audiences.Take(2))
                    {
                        <span class="badge bg-secondary-subtle text-dark me-1">@a</span>
                    }
                    @if (audiences.Count > 2)
                    {
                        <span class="text-muted">+@(@audiences.Count - 2)</span>
                    }
                </div>

                <!-- ACTION -->
                <div class="col-md-1 text-end">
                    <a href="scheme-detail?id=@obj.Id" class="btn btn-sm btn-outline-primary">
                        View <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        }

    </div>

    <!-- Pagination -->
    <nav class="mt-3">
        <ul id="pagination" class="pagination justify-content-end"></ul>
    </nav>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(function () {

        const itemsPerPage = 5;
        let currentPage = 1;

        const allItems = $('.hotel-item');
        let workingItems = allItems;

        function render() {
            allItems.hide();
            workingItems
                .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)
                .show();
        }

        function buildPagination() {
            const totalPages = Math.ceil(workingItems.length / itemsPerPage);
            $('#pagination').empty();

            for (let i = 1; i <= totalPages; i++) {
                $('#pagination').append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#">${i}</a>
                    </li>
                `);
            }
        }

        $('#pagination').on('click', 'a', function (e) {
            e.preventDefault();
            currentPage = Number($(this).text());
            render();
            buildPagination();
        });

        // SEARCH
        $('#customSearch').on('keyup', function () {
            const term = $(this).val().toLowerCase();

            workingItems = !term
                ? allItems
                : allItems.filter(function () {
                    return $(this).text().toLowerCase().includes(term);
                });

            currentPage = 1;
            buildPagination();
            render();
        });

         // SORT
    $('#sortBy').on('change', function () {
        let sorted = workingItems.toArray();
        const val = $(this).val();

        if (val === 'name-asc') {
            sorted.sort((a, b) =>
                $(a).data('name').localeCompare($(b).data('name'))
            );
        }

        if (val === 'status-asc') {
            sorted.sort((a, b) =>
                $(a).data('status').localeCompare($(b).data('status'))
            );
        }

        if (val === 'level-asc') {
            sorted.sort((a, b) =>
                $(a).data('level').localeCompare($(b).data('level'))
            );
        }

        $('#hotelWrapper').append(sorted);
        workingItems = $(sorted);

        currentPage = 1;
        buildPagination();
        render();
    });

        buildPagination();
        render();
    });
</script>
