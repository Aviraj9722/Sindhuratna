@inject Umbraco.Cms.Core.IPublishedContentQuery ContentQuery
@{
    var root = ContentQuery.ContentAtRoot().FirstOrDefault();
    // var homePage = root as Root;

    var Places = root?
         .DescendantsOfType("touristPlace")
         .OfType<TouristPlace>()
         .ToList();
}
@{
    Layout = "~/Views/Shared/_SindhuratnLayout.cshtml";
}

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- DataTables -->
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">

<!-- Font Awesome Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<style>
    .place-thumb {
        /* width: 70px;
        height: 70px; */
        object-fit: cover;
    }

    @@media (max-width: 768px) {
        .place-thumb

    {
        width: 100%;
        height: 120px;
    }

    }
</style>
<div class="container mt-4">
    <h4 class="mb-3 fw-semibold">
        <i class="fa-solid fa-map-location-dot text-warning"></i> Tourist Places
    </h4>

    <!-- Search + Sort -->
    <div class="row align-items-center mb-2">
        <div class="col-md-6">
            <input type="text"
                   id="customSearch"
                   class="form-control"
                   placeholder="Search place, location, type...">
        </div>

        <div class="col-md-6 text-end">
            <select id="sortBy" class="form-select w-auto d-inline">
                <option value="">Sort By</option>
                <option value="name-asc">Name A → Z</option>
                <option value="fee-asc">Entry Fee: Low → High</option>
                <option value="fee-desc">Entry Fee: High → Low</option>
            </select>
        </div>
    </div>

    <!-- Header -->
    <div class="row fw-bold border-bottom py-2 text-muted d-none d-sm-flex">

        <div class="col-md-2">Place</div>
        <div class="col-md-2">Description</div>
        <div class="col-md-2">Type</div>
        <div class="col-md-2">Location</div>      
        <div class="col-md-1">Fee</div>
        <div class="col-md-2">Best Season</div>       
        <div class="col-md-1 text-end">Action</div>
    </div>

    <!-- DATA -->
    <div id="hotelWrapper">
        @foreach (var obj in Places)
        {
            <div class="row align-items-center border-bottom py-3 hotel-item"
                 data-name="@obj.PlaceName"
                 data-fee="@obj.EntryFee">

                <div class="col-md-2">
                    <img src="@obj.Images?.FirstOrDefault()?.LocalCrops.Src"
                         class="img-fluid rounded shadow-sm place-thumb"
                         alt="@obj.PlaceName">
                </div>

                <div class="col-md-2 small text-muted">
                    <div class="fw-semibold text-dark mb-1">
                        <i class="fa-solid fa-landmark me-1 text-primary"></i>
                        @obj.PlaceName
                    </div>

                    <div>
                        @obj.ShortDescription
                    </div>
                </div>
              

                <div class="col-md-2">
                    <span class="badge bg-light text-dark">
                        <i class="fa-solid fa-tags"></i> @obj.PlaceType
                    </span>
                </div>
                <div class="col-md-2 text-muted">
                    
                    @* Google Maps Button *@
                    @if (!string.IsNullOrEmpty(obj?.Location))
                    {
                        var mapUrl = $"https://www.google.com/maps/search/?api=1&query={obj.Location.Replace(" ", "")}";

                        <a href="@mapUrl"
                           target="_blank"
                           class="btn btn-sm text-primary w-100" style="text-align:left">
                            <i class="fa-solid fa-map-location-dot me-1"></i>स्नकाशावर पहा
                        </a>
                    }
                </div>

                <div class="col-md-1 fw-semibold">
                    <i class="fa-solid fa-indian-rupee-sign"></i>
                    @obj.EntryFee
                </div>

                <div class="col-md-2">
                    <i class="fa-solid fa-calendar-days text-warning"></i>
                    @obj.BestSeason
                </div>


                <div class="col-md-1 text-end">
                    <a href="place-detail?id=@obj.Id" class="btn btn-sm btn-outline-primary">
                        View <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    <nav class="mt-3">
        <ul id="pagination" class="pagination justify-content-end"></ul>
    </nav>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(function () {

        const itemsPerPage = 5;
        let currentPage = 1;

        const allItems = $('.hotel-item');
        let workingItems = allItems;

        function render() {
            allItems.hide();
            workingItems
                .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)
                .show();
        }

        function buildPagination() {
            const totalPages = Math.ceil(workingItems.length / itemsPerPage);
            $('#pagination').empty();

            for (let i = 1; i <= totalPages; i++) {
                $('#pagination').append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#">${i}</a>
                    </li>
                `);
            }
        }

        $('#pagination').on('click', 'a', function (e) {
            e.preventDefault();
            currentPage = Number($(this).text());
            render();
            buildPagination();
        });

        // SEARCH
        $('#customSearch').on('keyup', function () {
            const term = $(this).val().toLowerCase();

            workingItems = !term
                ? allItems
                : allItems.filter(function () {
                    return $(this).text().toLowerCase().includes(term);
                });

            currentPage = 1;
            buildPagination();
            render();
        });

        // SORT
        $('#sortBy').on('change', function () {
            let sorted = workingItems.toArray();
            const val = $(this).val();

            if (val === 'name-asc') {
                sorted.sort((a, b) =>
                    $(a).data('name').localeCompare($(b).data('name'))
                );
            }

            if (val === 'fee-asc') {
                sorted.sort((a, b) => $(a).data('fee') - $(b).data('fee'));
            }

            if (val === 'fee-desc') {
                sorted.sort((a, b) => $(b).data('fee') - $(a).data('fee'));
            }

            $('#hotelWrapper').append(sorted);
            workingItems = $(sorted);

            currentPage = 1;
            buildPagination();
            render();
        });

        buildPagination();
        render();
    });
</script>
